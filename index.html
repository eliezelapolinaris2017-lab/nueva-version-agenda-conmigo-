<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Salon Pro ‚Äî Facturaci√≥n & Citas</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f0f12">
<style>
/* =========================
   THEME / DESIGN ELEGANTE
   ========================= */
:root{
  /* Colores base (100% editables en Configuraci√≥n) */
  --bg:#0f0f12;
  --fg:#ffffff;
  --muted:#a7a7b1;
  --primary:#6ee7b7;
  --primary-2:#22c55e;
  --accent:#93c5fd;
  --danger:#ef4444;
  --warn:#f59e0b;
  --card:#171821;
  --card-2:#1e202b;
  --topbar:#11121a;
  --footer:#0c0d12;
  --btn:#24263a;
  --outline:#2a2d40;
  --shadow:0 10px 30px rgba(0,0,0,.35);
  --radius:18px;
  --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Inter, Roboto, "Helvetica Neue", Arial;
  /* Opacidad de fondo (para ‚Äúfondo transparente‚Äù): 1 = s√≥lido, 0.75 = trasl√∫cido */
  --bg-opacity:1;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background: rgba(15,15,18,var(--bg-opacity));
  color:var(--fg); font-family:var(--font); -webkit-font-smoothing:antialiased;
  background-image: var(--bg-image, none);
  background-size: cover; background-position:center; background-attachment:fixed;
}
a{color:inherit; text-decoration:none}
button{cursor:pointer; border:0; background:var(--btn); color:#fff; border-radius:12px; padding:.8rem 1rem; box-shadow:var(--shadow); transition:transform .18s ease, opacity .18s ease}
button:hover{transform:translateY(-1px)}
.btn-primary{background:linear-gradient(135deg,var(--primary),var(--accent))}
.btn-danger{background:linear-gradient(135deg,var(--danger),#b91c1c)}
.btn-warn{background:linear-gradient(135deg,var(--warn),#f59e0b)}
.btn-ghost{background:transparent; border:1px solid var(--outline)}
.input, select, textarea{
  width:100%; padding:.78rem .9rem; background:#11131a; color:#fff; border:1px solid var(--outline);
  border-radius:12px; outline:none; transition:border-color .15s ease, box-shadow .15s ease
}
.input:focus, select:focus, textarea:focus{border-color:var(--accent); box-shadow:0 0 0 3px rgba(147,197,253,.25)}
label{display:block; font-size:.9rem; color:var(--muted); margin:.1rem 0 .35rem}
.card{
  background: linear-gradient(180deg, var(--card), var(--card-2));
  border:1px solid var(--outline);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding:1.1rem;
}
.row{display:grid; gap:1rem}
.row.cols-2{grid-template-columns:1fr 1fr}
.row.cols-3{grid-template-columns:repeat(3,1fr)}
.row.cols-4{grid-template-columns:repeat(4,1fr)}
@media (max-width:980px){
  .row.cols-2,.row.cols-3,.row.cols-4{grid-template-columns:1fr}
}
.table{width:100%; border-collapse:separate; border-spacing:0 10px}
.table th, .table td{padding:.75rem .9rem; text-align:left}
.table thead th{color:#cdd4ff; font-weight:600; font-size:.9rem}
.tr{
  background: linear-gradient(180deg,#141726,#0f1220);
  border:1px solid var(--outline);
  border-radius:12px;
}
.tr td:first-child,.tr th:first-child{border-top-left-radius:12px; border-bottom-left-radius:12px}
.tr td:last-child,.tr th:last-child{border-top-right-radius:12px; border-bottom-right-radius:12px}
.badge{display:inline-flex; align-items:center; gap:.4rem; padding:.25rem .6rem; background:#101323; border:1px solid var(--outline); border-radius:999px; font-size:.78rem; color:#c7d2fe}
.kpis{display:grid; grid-template-columns:repeat(4,1fr); gap:1rem}
.kpi{padding:1rem; border-radius:16px; background:#10121a; border:1px solid var(--outline)}
.kpi .label{color:#b5bad6; font-size:.85rem}
.kpi .value{font-size:1.4rem; font-weight:700}
.topbar{
  position:sticky; top:0; z-index:50;
  background: linear-gradient(180deg,var(--topbar), rgba(17,18,26,.85));
  backdrop-filter: blur(8px);
  border-bottom:1px solid var(--outline);
}
.topbar-inner{display:flex; align-items:center; gap:1rem; padding:.8rem 1rem}
.brand{display:flex; align-items:center; gap:.7rem}
.brand img{width:36px; height:36px; border-radius:10px; object-fit:cover; border:1px solid var(--outline)}
.brand .title{font-weight:800; letter-spacing:.2px}
.top-actions{margin-left:auto; display:flex; gap:.5rem; align-items:center}
.top-actions .avatar{width:34px; height:34px; border-radius:50%; background:#0f1118; border:1px solid var(--outline)}
.container{max-width:1160px; margin:1.2rem auto; padding:0 1rem 4rem}
.footer{
  margin-top:3rem; padding:1.2rem; text-align:center; color:#9aa3c7;
  border-top:1px solid var(--outline); background:var(--footer)
}
/* Pantallas */
.screen{display:none}
.screen.active{display:block; animation:fade .18s ease}
@keyframes fade{from{opacity:.5; transform:translateY(2px)} to{opacity:1; transform:none}}
/* Men√∫ principal como tarjetas */
.menu-grid{display:grid; grid-template-columns:repeat(3,1fr); gap:1rem}
.menu-card{display:flex; flex-direction:column; gap:.75rem; padding:1.1rem; border-radius:18px; border:1px solid var(--outline); background:linear-gradient(180deg,#121422,#0d1020)}
.menu-card h3{margin:0; font-size:1.05rem}
.menu-card p{margin:0; color:#aeb6d9; font-size:.9rem}
.menu-card .actions{display:flex; gap:.6rem; margin-top:.6rem; flex-wrap:wrap}
.backline{display:flex; align-items:center; gap:.7rem; margin-bottom:1rem}
.backline button{padding:.6rem .8rem}
.small{font-size:.85rem}
.right{margin-left:auto}
.help{color:#a9b2dc; font-size:.85rem}
/* Login */
.login-wrap{max-width:440px; margin:6vh auto}
.logo-preview{width:56px; height:56px; border-radius:12px; object-fit:cover; border:1px solid var(--outline); background:#0e1020}
.center{text-align:center}
hr.sep{border:0; height:1px; background:linear-gradient(90deg, transparent, #28304a, transparent); margin:1rem 0}
/* Chips */
.chips{display:flex; gap:.5rem; flex-wrap:wrap}
.chip{padding:.35rem .6rem; border-radius:999px; border:1px solid var(--outline); background:#0c0f1e; color:#c7cff7; font-size:.78rem}
/* Upload previews */
.preview{width:100%; max-height:220px; object-fit:contain; background:#0b0e1a; border:1px dashed var(--outline); border-radius:12px; padding:.6rem}
/* Floating helpers */
.toolbar{display:flex; gap:.5rem; align-items:center; flex-wrap:wrap}
.spacer{flex:1}
.hidden{display:none !important}
/* Print styles (para exportar a PDF con imprimir) */
@media print{
  body{background:white !important; color:black !important}
  .topbar, .footer, .no-print{display:none !important}
  .card, .tr{box-shadow:none; border:1px solid #ddd}
}
</style>
</head>
<body>
<!-- =========================
     TOPBAR + MENU
     ========================= -->
<header class="topbar">
  <div class="topbar-inner">
    <div class="brand">
      <img id="brandLogo" alt="logo">
      <div>
        <div class="title" id="brandName">Salon Pro</div>
        <div class="small" id="brandSub">Agenda & Facturaci√≥n</div>
      </div>
    </div>
    <div class="top-actions no-print">
      <button id="btnHome" class="btn-ghost" title="Men√∫">Men√∫</button>
      <button id="btnConfig" class="btn-ghost" title="Configuraci√≥n">Config</button>
      <button id="btnLogout" class="btn-danger" title="Salir">Salir</button>
      <div class="avatar" title="Usuario" id="whoami"></div>
    </div>
  </div>
</header>

<main class="container">
  <!-- =========================
       PANTALLA: LOGIN
       ========================= -->
  <section id="screen-login" class="screen active">
    <div class="login-wrap">
      <div class="center">
        <img id="loginLogo" class="logo-preview" alt="Logo">
        <h1 style="margin:.6rem 0 0">Bienvenido</h1>
        <p class="help">Inicia sesi√≥n para continuar</p>
      </div>
      <div class="card" style="margin-top:1rem">
        <div class="row cols-2">
          <div>
            <label>Usuario</label>
            <input id="loginUser" class="input" placeholder="admin o usuario">
          </div>
          <div>
            <label>Contrase√±a</label>
            <input id="loginPass" type="password" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
          </div>
        </div>
        <div class="row" style="margin-top:.8rem">
          <button id="doLogin" class="btn-primary">Entrar</button>
          <div class="chips">
            <span class="chip">admin / admin123 (rol admin)</span>
            <span class="chip">usuario / user123 (rol usuario)</span>
          </div>
        </div>
      </div>
      <hr class="sep">
      <div class="card">
        <b>Notas r√°pidas</b>
        <p class="help">El rol <b>admin</b> ve todas las secciones. El rol <b>usuario</b> solo puede usar <i>Agenda</i> y <i>Facturaci√≥n</i>.</p>
      </div>
    </div>
  </section>

  <!-- =========================
       PANTALLA: INICIO / MEN√ö
       ========================= -->
  <section id="screen-home" class="screen">
    <div class="row">
      <div class="backline no-print">
        <h2 style="margin:0">Men√∫ principal</h2>
        <span class="spacer"></span>
        <span class="help">Selecciona una secci√≥n</span>
      </div>
      <div class="menu-grid">
        <div class="menu-card">
          <h3>Agenda de citas</h3>
          <p>Crear, listar, evitar duplicados, ‚Äúno show‚Äù, WhatsApp y Google.</p>
          <div class="actions">
            <button class="btn-primary" data-goto="screen-agenda">Abrir Agenda</button>
          </div>
        </div>
        <div class="menu-card">
          <h3>Facturaci√≥n</h3>
          <p>Genera facturas y env√≠alas por WhatsApp. Exporta PDF/Excel (CSV).</p>
          <div class="actions">
            <button class="btn-primary" data-goto="screen-facturacion">Abrir Facturaci√≥n</button>
          </div>
        </div>
        <div class="menu-card">
          <h3>Exportaciones</h3>
          <p>Por empleado / d√≠a / semana / mes / a√±o (PDF / Excel CSV).</p>
          <div class="actions">
            <button class="btn-primary" data-goto="screen-export">Abrir Exportaciones</button>
          </div>
        </div>
        <div class="menu-card">
          <h3>An√°lisis de rendimiento</h3>
          <p>KPIs y gr√°ficas sin librer√≠as externas.</p>
          <div class="actions">
            <button class="btn-primary" data-goto="screen-analytics">Ver An√°lisis</button>
          </div>
        </div>
        <div class="menu-card">
          <h3>Empleados</h3>
          <p>A√±ade / edita empleados para agenda y facturas.</p>
          <div class="actions">
            <button class="btn-primary" data-goto="screen-empleados">Gestionar</button>
          </div>
        </div>
        <div class="menu-card">
          <h3>Configuraci√≥n</h3>
          <p>Colores, logo, fondo, Google, ATH M√≥vil, exportar/importar.</p>
          <div class="actions">
            <button class="btn-primary" data-goto="screen-config">Abrir Config</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- =========================
       PANTALLA: AGENDA
       ========================= -->
  <section id="screen-agenda" class="screen">
    <div class="backline">
      <button class="btn-ghost" data-goto="screen-home">‚Üê Regresar</button>
      <h2 style="margin:0">Agenda de Citas</h2>
      <span class="spacer"></span>
      <button id="btnAgendaImprimir" class="btn-ghost no-print">Imprimir</button>
    </div>

    <div class="card">
      <div class="row cols-4">
        <div>
          <label>Cliente</label>
          <input id="a_nombre" class="input" placeholder="Nombre y apellidos">
        </div>
        <div>
          <label>Tel√©fono</label>
          <input id="a_tel" class="input" placeholder="+1 787 000 0000">
        </div>
        <div>
          <label>Empleado/T√©cnica</label>
          <select id="a_emp" class="input"></select>
        </div>
        <div>
          <label>Servicio</label>
          <input id="a_srv" class="input" placeholder="Corte, color, etc.">
        </div>
      </div>
      <div class="row cols-4" style="margin-top:.6rem">
        <div>
          <label>Fecha</label>
          <input id="a_fecha" type="date" class="input">
        </div>
        <div>
          <label>Hora</label>
          <input id="a_hora" type="time" class="input" step="900">
        </div>
        <div>
          <label>Duraci√≥n (min)</label>
          <input id="a_dur" type="number" class="input" value="60" min="15" step="15">
        </div>
        <div>
          <label>Notas</label>
          <input id="a_notas" class="input" placeholder="Observaciones">
        </div>
      </div>
      <div class="toolbar" style="margin-top:.7rem">
        <button id="btnAgendaGuardar" class="btn-primary">Guardar cita</button>
        <button id="btnAgendaNoShow" class="btn-warn">Marcar No Show</button>
        <div class="spacer"></div>
        <button id="btnAgendaGoogle" class="btn-ghost">Enviar a Google Form</button>
        <button id="btnAgendaWhatsApp" class="btn-ghost">WhatsApp confirmaci√≥n</button>
      </div>
    </div>

    <div class="row" style="margin-top:1rem">
      <div class="card">
        <div class="toolbar">
          <b>Listado de citas</b>
          <div class="spacer"></div>
          <label class="small">Filtrar por fecha</label>
          <input id="f_fecha" type="date" class="input" style="width:auto">
          <label class="small">Empleado</label>
          <select id="f_emp" class="input" style="width:auto"></select>
          <button id="btnAgendaFiltrar" class="btn-ghost">Aplicar</button>
        </div>
        <table class="table" id="tblCitas">
          <thead><tr class="tr">
            <th>Fecha</th><th>Hora</th><th>Cliente</th><th>Empleado</th><th>Servicio</th><th>Tel</th><th>Estado</th><th class="no-print">Acciones</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- =========================
       PANTALLA: FACTURACI√ìN
       ========================= -->
  <section id="screen-facturacion" class="screen">
    <div class="backline">
      <button class="btn-ghost" data-goto="screen-home">‚Üê Regresar</button>
      <h2 style="margin:0">Facturaci√≥n</h2>
      <span class="spacer"></span>
      <button id="btnFacturaImprimir" class="btn-ghost no-print">Imprimir</button>
    </div>

    <div class="card">
      <div class="row cols-4">
        <div>
          <label># Factura</label>
          <input id="f_num" class="input" placeholder="AUTOM√ÅTICO" disabled>
        </div>
        <div>
          <label>Cliente</label>
          <input id="f_cli" class="input" placeholder="Nombre y apellidos">
        </div>
        <div>
          <label>Tel√©fono</label>
          <input id="f_tel" class="input" placeholder="+1 787 ...">
        </div>
        <div>
          <label>Empleado</label>
          <select id="f_emp" class="input"></select>
        </div>
      </div>
      <div class="row cols-4" style="margin-top:.6rem">
        <div>
          <label>Fecha</label>
          <input id="f_fecha" type="date" class="input">
        </div>
        <div>
          <label>M√©todo de pago</label>
          <select id="f_pago" class="input">
            <option>ATH M√≥vil</option>
            <option>Tarjeta</option>
            <option>Cash</option>
          </select>
        </div>
        <div>
          <label>IVU %</label>
          <input id="f_ivu" type="number" class="input" value="11.5" step=".1" min="0">
        </div>
        <div>
          <label>Notas</label>
          <input id="f_notas" class="input" placeholder="Opcional">
        </div>
      </div>
      <div class="row" style="margin-top:.6rem">
        <div class="toolbar">
          <b>Conceptos</b>
          <div class="spacer"></div>
          <button id="btnAddLinea" class="btn-ghost">A√±adir l√≠nea</button>
          <button id="btnLoadServicios" class="btn-ghost">Servicios guardados</button>
        </div>
        <div id="lineas"></div>
        <hr class="sep">
        <div class="row cols-3">
          <div class="card">
            <div class="row cols-2">
              <div>
                <label>Subtotal</label>
                <input id="f_sub" class="input" disabled>
              </div>
              <div>
                <label>IVU</label>
                <input id="f_tax" class="input" disabled>
              </div>
            </div>
            <div class="row" style="margin-top:.6rem">
              <label>Total</label>
              <input id="f_total" class="input" disabled>
            </div>
          </div>
          <div class="card">
            <b>ATH M√≥vil / QR</b>
            <div class="row">
              <input id="ath_alias" class="input" placeholder="Alias o N√∫mero de ATH M√≥vil">
              <input id="ath_monto" class="input" placeholder="Monto a cobrar (auto)" disabled>
              <label class="small">Sube tu c√≥digo QR</label>
              <input id="ath_qr" type="file" accept="image/*" class="input">
              <img id="ath_preview" class="preview" alt="QR ATH M√≥vil">
            </div>
          </div>
          <div class="card">
            <b>Acciones</b>
            <div class="row">
              <button id="btnFacturaGuardar" class="btn-primary">Guardar Factura</button>
              <button id="btnFacturaWhatsApp" class="btn-ghost">Enviar por WhatsApp</button>
              <button id="btnFacturaExportPDF" class="btn-ghost">Exportar PDF (Imprimir)</button>
              <button id="btnFacturaExportCSV" class="btn-ghost">Exportar Excel (CSV)</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:1rem">
      <div class="card">
        <div class="toolbar">
          <b>Historial de facturas</b>
          <div class="spacer"></div>
          <label class="small">Rango</label>
          <input id="h_desde" type="date" class="input" style="width:auto">
          <input id="h_hasta" type="date" class="input" style="width:auto">
          <label class="small">Empleado</label>
          <select id="h_emp" class="input" style="width:auto"></select>
          <button id="btnHistFiltrar" class="btn-ghost">Filtrar</button>
        </div>
        <table class="table" id="tblFacturas">
          <thead><tr class="tr">
            <th>#</th><th>Fecha</th><th>Cliente</th><th>Empleado</th><th>M√©todo</th><th>Total</th><th class="no-print">Acciones</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>
  <!-- =========================
       PANTALLA: EXPORTACIONES
       ========================= -->
  <section id="screen-export" class="screen">
    <div class="backline">
      <button class="btn-ghost" data-goto="screen-home">‚Üê Regresar</button>
      <h2 style="margin:0">Exportaciones</h2>
    </div>
    <div class="card">
      <div class="row cols-4">
        <div>
          <label>Tipo</label>
          <select id="ex_tipo" class="input">
            <option value="facturas">Facturas</option>
            <option value="citas">Citas</option>
          </select>
        </div>
        <div>
          <label>Empleado</label>
          <select id="ex_emp" class="input"></select>
        </div>
        <div>
          <label>Per√≠odo</label>
          <select id="ex_periodo" class="input">
            <option value="dia">D√≠a</option>
            <option value="semana">Semana</option>
            <option value="mes">Mes</option>
            <option value="anio">A√±o</option>
            <option value="rango">Rango personalizado</option>
          </select>
        </div>
        <div>
          <label>Fecha base / inicio</label>
          <input id="ex_fecha" type="date" class="input">
        </div>
      </div>
      <div class="row cols-2" style="margin-top:.6rem" id="ex_rango_wrap" class="hidden">
        <div>
          <label>Desde</label>
          <input id="ex_desde" type="date" class="input">
        </div>
        <div>
          <label>Hasta</label>
          <input id="ex_hasta" type="date" class="input">
        </div>
      </div>
      <div class="toolbar" style="margin-top:.8rem">
        <button id="btnExportCSV" class="btn-ghost">Exportar Excel (CSV)</button>
        <button id="btnExportPrint" class="btn-ghost">Exportar PDF (Imprimir)</button>
      </div>
    </div>
    <div class="card" style="margin-top:1rem">
      <b>Vista previa</b>
      <table class="table" id="tblExport">
        <thead><tr class="tr" id="exHead"></tr></thead>
        <tbody id="exBody"></tbody>
      </table>
    </div>
  </section>

  <!-- =========================
       PANTALLA: ANALYTICS
       ========================= -->
  <section id="screen-analytics" class="screen">
    <div class="backline">
      <button class="btn-ghost" data-goto="screen-home">‚Üê Regresar</button>
      <h2 style="margin:0">An√°lisis de rendimiento</h2>
    </div>

    <div class="kpis">
      <div class="kpi">
        <div class="label">Ingresos (hoy)</div>
        <div class="value" id="kpi_ingresos_hoy">$0</div>
      </div>
      <div class="kpi">
        <div class="label">Ingresos (mes)</div>
        <div class="value" id="kpi_ingresos_mes">$0</div>
      </div>
      <div class="kpi">
        <div class="label">Citas (hoy)</div>
        <div class="value" id="kpi_citas_hoy">0</div>
      </div>
      <div class="kpi">
        <div class="label">No Shows (mes)</div>
        <div class="value" id="kpi_noshow_mes">0</div>
      </div>
    </div>

    <div class="row" style="margin-top:1rem">
      <div class="card">
        <div class="toolbar">
          <b>Ingresos diarios (√∫ltimos 30 d√≠as)</b>
          <div class="spacer"></div>
          <span class="help">Gr√°fica canvas sin librer√≠as</span>
        </div>
        <canvas id="chart30" height="180"></canvas>
      </div>
    </div>
  </section>

  <!-- =========================
       PANTALLA: EMPLEADOS
       ========================= -->
  <section id="screen-empleados" class="screen">
    <div class="backline">
      <button class="btn-ghost" data-goto="screen-home">‚Üê Regresar</button>
      <h2 style="margin:0">Empleados / T√©cnicas</h2>
    </div>
    <div class="card">
      <div class="row cols-3">
        <div>
          <label>Nombre</label>
          <input id="e_nombre" class="input" placeholder="Jane Doe">
        </div>
        <div>
          <label>Tel√©fono</label>
          <input id="e_tel" class="input" placeholder="+1 787 ...">
        </div>
        <div>
          <label>Activo</label>
          <select id="e_activo" class="input">
            <option value="1">S√≠</option>
            <option value="0">No</option>
          </select>
        </div>
      </div>
      <div class="toolbar" style="margin-top:.8rem">
        <button id="btnEmpGuardar" class="btn-primary">A√±adir / Actualizar</button>
        <button id="btnEmpLimpiar" class="btn-ghost">Limpiar</button>
      </div>
    </div>
    <div class="card" style="margin-top:1rem">
      <table class="table" id="tblEmpleados">
        <thead><tr class="tr"><th>Nombre</th><th>Tel</th><th>Estado</th><th class="no-print">Acciones</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- =========================
       PANTALLA: CONFIGURACI√ìN
       ========================= -->
  <section id="screen-config" class="screen">
    <div class="backline">
      <button class="btn-ghost" data-goto="screen-home">‚Üê Regresar</button>
      <h2 style="margin:0">Configuraci√≥n</h2>
      <span class="spacer"></span>
      <button id="btnExportConfig" class="btn-ghost">Exportar configuraci√≥n</button>
      <label class="small">Importar</label><input id="cfgImport" type="file" accept="application/json" class="input" style="width:auto">
    </div>

    <div class="card">
      <b>Branding</b>
      <div class="row cols-4">
        <div>
          <label>Nombre del negocio</label>
          <input id="cfg_name" class="input" placeholder="Salon Pro">
        </div>
        <div>
          <label>Lema / Subt√≠tulo</label>
          <input id="cfg_sub" class="input" placeholder="Agenda & Facturaci√≥n">
        </div>
        <div>
          <label>Logo</label>
          <input id="cfg_logo" type="file" accept="image/*" class="input">
        </div>
        <div>
          <label>Previsualizaci√≥n</label>
          <img id="cfg_logo_prev" class="preview" alt="Logo">
        </div>
      </div>
      <div class="row cols-4" style="margin-top:.6rem">
        <div>
          <label>Fondo (imagen)</label>
          <input id="cfg_bg" type="file" accept="image/*" class="input">
        </div>
        <div>
          <label>Opacidad de fondo (0.6 a 1)</label>
          <input id="cfg_bg_op" type="number" step=".05" min="0.6" max="1" value="1" class="input">
        </div>
        <div>
          <label>Color primario</label>
          <input id="cfg_primary" type="color" class="input" value="#6ee7b7">
        </div>
        <div>
          <label>Color acento</label>
          <input id="cfg_accent" type="color" class="input" value="#93c5fd">
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:1rem">
      <b>Servicios guardados (para facturaci√≥n)</b>
      <div class="row cols-3">
        <div>
          <label>Servicio</label>
          <input id="sv_nombre" class="input" placeholder="Corte de cabello">
        </div>
        <div>
          <label>Precio</label>
          <input id="sv_precio" type="number" step=".01" class="input" placeholder="25.00">
        </div>
        <div style="display:flex; align-items:flex-end">
          <button id="btnSvAgregar" class="btn-ghost">Agregar servicio</button>
        </div>
      </div>
      <div class="row" style="margin-top:.6rem">
        <table class="table" id="tblServicios">
          <thead><tr class="tr"><th>Servicio</th><th>Precio</th><th class="no-print">Acciones</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card" style="margin-top:1rem">
      <b>Integraci√≥n Google (Form + Apps Script)</b>
      <div class="row cols-2">
        <div>
          <label>URL de Google Form (respuesta)</label>
          <input id="cfg_form_url" class="input" placeholder="https://docs.google.com/forms/d/e/.../formResponse">
          <p class="help">Se usar√° para enviar citas (POST). Debe tener campos ‚Äúnombre, tel, empleado, fecha, hora, servicio, notas‚Äù.</p>
        </div>
        <div>
          <label>URL Web App Apps Script (opcional)</label>
          <input id="cfg_script_url" class="input" placeholder="https://script.google.com/macros/s/.../exec">
          <p class="help">Para guardar/leer datos desde Google Sheets (como base de datos).</p>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:1rem">
      <b>WhatsApp / Direcci√≥n</b>
      <div class="row cols-3">
        <div>
          <label>Tel√©fono WhatsApp</label>
          <input id="cfg_wa_phone" class="input" placeholder="17876643079">
        </div>
        <div>
          <label>Texto base facturas</label>
          <input id="cfg_wa_fact" class="input" placeholder="Gracias por su compra. Enlace/Detalle:">
        </div>
        <div>
          <label>Ubicaci√≥n (Maps URL)</label>
          <input id="cfg_maps" class="input" placeholder="https://maps.google.com/?q=...">
        </div>
      </div>
    </div>
  </section>

  <!-- =========================
       FOOTER
       ========================= -->
  <footer class="footer">
    <div>¬© <span id="year"></span> <span id="footerName">Salon Pro</span> ‚Äî Todos los derechos reservados.</div>
  </footer>
</main>

<!-- =========================
     JS APP
     ========================= -->
<script>
/* ============================================================
   STORAGE KEYS
   ============================================================ */
const K = {
  USERS: 'sp_users',
  SESSION: 'sp_session',
  EMP: 'sp_empleados',
  CITAS: 'sp_citas',
  FACTS: 'sp_facturas',
  CFG: 'sp_config',
  SVC: 'sp_servicios',
  COUNTER_F: 'sp_fact_counter'
};

/* ============================================================
   UTILIDADES
   ============================================================ */
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const byId = id => document.getElementById(id);
const fmtMoney = n => (Number(n||0)).toLocaleString('es-PR',{style:'currency',currency:'USD'});
const todayISO = () => new Date().toISOString().slice(0,10);
const uuid = () => crypto.randomUUID ? crypto.randomUUID() : (Date.now().toString(36)+Math.random().toString(36).slice(2));
const save = (k,v)=>localStorage.setItem(k,JSON.stringify(v));
const load = (k,d=null)=>JSON.parse(localStorage.getItem(k)||JSON.stringify(d));
const download = (filename, content, type='text/plain')=>{
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([content],{type}));
  a.download=filename; a.click(); URL.revokeObjectURL(a.href);
};
   
/* ============================================================
   ESTADO INICIAL / DEMO USERS
   ============================================================ */
function ensureDefaults(){
  if(!load(K.USERS)) save(K.USERS, [
    {user:'admin', pass:'admin123', role:'admin'},
    {user:'usuario', pass:'user123', role:'usuario'}
  ]);
  if(!load(K.EMP)) save(K.EMP, [
    {id:uuid(), nombre:'Cynthia', tel:'', activo:1},
    {id:uuid(), nombre:'Mar√≠a', tel:'', activo:1}
  ]);
  if(load(K.COUNTER_F)==null) save(K.COUNTER_F, 1001);
  if(!load(K.CFG)) save(K.CFG, {
    name:'Salon Pro', sub:'Agenda & Facturaci√≥n',
    primary:'#6ee7b7', accent:'#93c5fd', bgOpacity:1,
    logo:null, bg:null,
    formUrl:'', scriptUrl:'',
    waPhone:'17876643079', waFacto:'Gracias por su compra. Detalle:',
    maps:''
  });
  if(!load(K.SVC)) save(K.SVC, [
    {id:uuid(), nombre:'Corte de cabello', precio:25},
    {id:uuid(), nombre:'Color', precio:60}
  ]);
  if(!load(K.CITAS)) save(K.CITAS, []);
  if(!load(K.FACTS)) save(K.FACTS, []);
}

/* ============================================================
   RENDER THEME / BRAND
   ============================================================ */
function applyBrand(){
  const cfg=load(K.CFG,{});
  byId('brandName').textContent = cfg.name||'Salon Pro';
  byId('brandSub').textContent  = cfg.sub || 'Agenda & Facturaci√≥n';
  byId('footerName').textContent= cfg.name||'Salon Pro';
  byId('year').textContent = new Date().getFullYear();
  document.documentElement.style.setProperty('--primary', cfg.primary||'#6ee7b7');
  document.documentElement.style.setProperty('--accent',  cfg.accent ||'#93c5fd');
  document.documentElement.style.setProperty('--bg-opacity', cfg.bgOpacity ?? 1);
  if(cfg.bg){
    document.body.style.setProperty('--bg-image', `url('${cfg.bg}')`);
  }else{
    document.body.style.removeProperty('--bg-image');
  }
  const logoTargets=['brandLogo','loginLogo','cfg_logo_prev'];
  logoTargets.forEach(id=>{
    const el=byId(id); if(!el) return;
    if(cfg.logo){ el.src = cfg.logo; } else { el.removeAttribute('src'); }
  });
}

/* ============================================================
   NAVEGACI√ìN ENTRE PANTALLAS
   ============================================================ */
function show(id){
  $$('.screen').forEach(s=>s.classList.remove('active'));
  byId(id).classList.add('active');
  // Rol: ocultar pantallas para usuario regular
  const ses = load(K.SESSION);
  if(ses?.role==='usuario'){
    // Usuario solo agenda y facturaci√≥n
    ['screen-export','screen-analytics','screen-empleados','screen-config'].forEach(h=>{
      const el=byId(h); if(el) el.classList.add('hidden');
    });
  }else{
    ['screen-export','screen-analytics','screen-empleados','screen-config'].forEach(h=>{
      const el=byId(h); if(el) el.classList.remove('hidden');
    });
  }
}

/* ============================================================
   LOGIN
   ============================================================ */
function login(user, pass){
  const users=load(K.USERS,[]);
  const u=users.find(x=>x.user===user && x.pass===pass);
  if(!u) return false;
  save(K.SESSION,{user:u.user, role:u.role});
  byId('whoami').title=`${u.user} (${u.role})`;
  return true;
}
function logout(){
  localStorage.removeItem(K.SESSION);
  show('screen-login');
}

/* ============================================================
   EMPLEADOS
   ============================================================ */
function renderEmpleadosSelects(){
  const emps=load(K.EMP,[]);
  const lists = ['a_emp','f_emp','h_emp','f_emp','ex_emp','f_emp','f_emp','f_emp']; // redundante intencional (varios selects)
  lists.forEach(id=>{
    const el=byId(id); if(!el) return;
    const sel=el.tagName==='SELECT';
    if(sel){
      el.innerHTML = `<option value="">Todos</option>` + emps.filter(e=>+e.activo===1).map(e=>`<option value="${e.id}">${e.nombre}</option>`).join('');
    }
  });
  // Filtros que no llevan "Todos"
  const only = ['f_emp','a_emp'];
  only.forEach(id=>{
    const el=byId(id); if(!el) return;
    el.innerHTML = emps.filter(e=>+e.activo===1).map(e=>`<option value="${e.id}">${e.nombre}</option>`).join('');
  });
}
function renderEmpleadosTabla(){
  const tb=byId('tblEmpleados').querySelector('tbody');
  const emps=load(K.EMP,[]);
  tb.innerHTML = emps.map(e=>`
    <tr class="tr">
      <td>${e.nombre}</td>
      <td>${e.tel||''}</td>
      <td>${+e.activo?'<span class="badge">Activo</span>':'<span class="badge" style="color:#ffb; border-color:#665">Inactivo</span>'}</td>
      <td class="no-print">
        <button class="btn-ghost" onclick="empEdit('${e.id}')">Editar</button>
        <button class="btn-danger" onclick="empDel('${e.id}')">Borrar</button>
      </td>
    </tr>`).join('');
}
function empEdit(id){
  const e=load(K.EMP,[]).find(x=>x.id===id); if(!e) return;
  byId('e_nombre').value = e.nombre;
  byId('e_tel').value    = e.tel||'';
  byId('e_activo').value = e.activo?'1':'0';
  byId('btnEmpGuardar').dataset.id = id;
}
function empDel(id){
  let emps=load(K.EMP,[]).filter(x=>x.id!==id);
  save(K.EMP, emps);
  renderEmpleadosTabla(); renderEmpleadosSelects();
}
function empSave(){
  const nombre=byId('e_nombre').value.trim();
  const tel=byId('e_tel').value.trim();
  const activo=+byId('e_activo').value;
  if(!nombre) return alert('Nombre requerido');
  let emps=load(K.EMP,[]);
  const idEdit = byId('btnEmpGuardar').dataset.id;
  if(idEdit){
    emps=emps.map(e=> e.id===idEdit ? {...e, nombre, tel, activo} : e);
    delete byId('btnEmpGuardar').dataset.id;
  }else{
    emps.push({id:uuid(), nombre, tel, activo});
  }
  save(K.EMP, emps);
  byId('e_nombre').value=''; byId('e_tel').value=''; byId('e_activo').value='1';
  renderEmpleadosTabla(); renderEmpleadosSelects();
}

/* ============================================================
   AGENDA (no duplicar, no show, WhatsApp, Google Form)
   ============================================================ */
function citaKey(c){ return [c.fecha,c.hora,c.emp,c.tel?.replace(/\D/g,'')].join('|').toLowerCase(); }
function citaDuplicada(cita, citas){
  return citas.some(x=>citaKey(x)===citaKey(cita));
}
function citaGuardar(){
  const nombre=byId('a_nombre').value.trim();
  const tel=byId('a_tel').value.trim();
  const emp=byId('a_emp').value;
  const srv=byId('a_srv').value.trim();
  const fecha=byId('a_fecha').value;
  const hora=byId('a_hora').value;
  const dur=+byId('a_dur').value||60;
  const notas=byId('a_notas').value.trim();
  if(!nombre || !tel || !emp || !fecha || !hora) return alert('Completa nombre, tel√©fono, empleado, fecha y hora.');
  let citas=load(K.CITAS,[]);
  const cita={id:uuid(), nombre,tel,emp,srv,fecha,hora,dur,notas, estado:'programada'};
  if(citaDuplicada(cita,citas)) return alert('Duplicado: ya existe cita con esa persona a esa hora.');
  citas.push(cita); save(K.CITAS,citas);
  renderCitas(); alert('Cita guardada.');
}
function citaNoShow(){
  const nombre=byId('a_nombre').value.trim();
  const tel=byId('a_tel').value.trim();
  const fecha=byId('a_fecha').value;
  const hora=byId('a_hora').value;
  let citas=load(K.CITAS,[]);
  citas=citas.map(c=>{
    if(c.nombre===nombre && c.tel===tel && c.fecha===fecha && c.hora===hora){
      return {...c, estado:'no-show'};
    }
    return c;
  });
  save(K.CITAS,citas); renderCitas(); alert('Marcado como No Show (si coincid√≠a).');
}
function renderCitas(filter=true){
  const tb=byId('tblCitas').querySelector('tbody');
  const emps=load(K.EMP,[]);
  const empName = id => (emps.find(e=>e.id===id)||{}).nombre||'‚Äî';
  let citas=load(K.CITAS,[]);
  if(filter){
    const fFecha=byId('f_fecha').value;
    const fEmp=byId('f_emp').value;
    if(fFecha) citas=citas.filter(c=>c.fecha===fFecha);
    if(fEmp) citas=citas.filter(c=>c.emp===fEmp);
  }
  citas.sort((a,b)=> (a.fecha+a.hora).localeCompare(b.fecha+b.hora));
  tb.innerHTML = citas.map(c=>`
    <tr class="tr">
      <td>${c.fecha}</td>
      <td>${c.hora}</td>
      <td>${c.nombre}</td>
      <td>${empName(c.emp)}</td>
      <td>${c.srv||''}</td>
      <td>${c.tel}</td>
      <td>${c.estado}</td>
      <td class="no-print">
        <button class="btn-ghost" onclick="citaWhatsApp('${c.id}')">WA</button>
        <button class="btn-ghost" onclick="citaEditar('${c.id}')">Editar</button>
        <button class="btn-danger" onclick="citaBorrar('${c.id}')">Borrar</button>
      </td>
    </tr>`).join('');
}
function citaEditar(id){
  const c=load(K.CITAS,[]).find(x=>x.id===id); if(!c) return;
  byId('a_nombre').value=c.nombre;
  byId('a_tel').value=c.tel;
  byId('a_emp').value=c.emp;
  byId('a_srv').value=c.srv||'';
  byId('a_fecha').value=c.fecha;
  byId('a_hora').value=c.hora;
  byId('a_dur').value=c.dur||60;
  byId('a_notas').value=c.notas||'';
}
function citaBorrar(id){
  let c=load(K.CITAS,[]).filter(x=>x.id!==id);
  save(K.CITAS,c); renderCitas();
}
function citaWhatsApp(id){
  const cfg=load(K.CFG,{});
  const c=load(K.CITAS,[]).find(x=>x.id===id); if(!c) return;
  const emps=load(K.EMP,[]); const empName=(emps.find(e=>e.id===c.emp)||{}).nombre||'';
  const fechaTxt=new Date(c.fecha+'T'+(c.hora||'00:00')).toLocaleString('es-PR');
  const msg = encodeURIComponent(
    `Hola ${c.nombre}, confirmaci√≥n de su cita:\n`+
    `üóì ${fechaTxt}\nüë§ T√©cnica: ${empName}\nüíà Servicio: ${c.srv||'-'}\n`+
    `${c.notas? 'üìù Notas: '+c.notas+'\n':''}`+
    `${cfg.maps? 'üìç Ubicaci√≥n: '+cfg.maps+'\n':''}`+
    `Responda este mensaje para confirmar. ¬°Gracias!`
  );
  const phone = cfg.waPhone?.replace(/\D/g,'')||'';
  window.open(`https://wa.me/${phone}?text=${msg}`,'_blank');
}
async function citaGoogle(){
  const cfg=load(K.CFG,{});
  if(!cfg.formUrl){ alert('Configura la URL de Google Form en Configuraci√≥n.'); return; }
  const nombre=byId('a_nombre').value.trim();
  const tel=byId('a_tel').value.trim();
  const emp=byId('a_emp').value;
  const srv=byId('a_srv').value.trim();
  const fecha=byId('a_fecha').value;
  const hora=byId('a_hora').value;
  const notas=byId('a_notas').value.trim();
  if(!nombre||!tel||!emp||!fecha||!hora) return alert('Completa campos requeridos.');
  // IMPORTANTE: Cambia entry.X por los entry del Form
  const payload = new URLSearchParams({
    'entry.1111':nombre,
    'entry.2222':tel,
    'entry.3333':emp,
    'entry.4444':srv,
    'entry.5555':fecha,
    'entry.6666':hora,
    'entry.7777':notas
  });
  try{
    await fetch(cfg.formUrl,{method:'POST', body:payload, mode:'no-cors'});
    alert('Enviado a Google Form.');
  }catch(e){ alert('Error enviando al Form. Revisa la URL.'); }
}

/* ============================================================
   FACTURACI√ìN (l√≠neas, totales, exportar, WhatsApp)
   ============================================================ */
function nextFacturaNumber(){
  let n=load(K.COUNTER_F,1001); save(K.COUNTER_F, n+1); return n;
}
function lineaTpl(id,data={}){
  return `
  <div class="row cols-4 tr" style="padding:.6rem; margin:.4rem 0">
    <div>
      <label>Descripci√≥n</label>
      <input data-id="${id}" data-k="desc" class="input" placeholder="Servicio o producto" value="${data.desc||''}">
    </div>
    <div>
      <label>Cant.</label>
      <input data-id="${id}" data-k="cant" type="number" min="1" step="1" class="input" value="${data.cant||1}">
    </div>
    <div>
      <label>Precio</label>
      <input data-id="${id}" data-k="precio" type="number" step=".01" class="input" value="${data.precio||0}">
    </div>
    <div style="display:flex; align-items:flex-end; gap:.5rem">
      <input data-id="${id}" data-k="total" class="input" disabled value="${fmtMoney((data.cant||1)*(data.precio||0))}">
      <button class="btn-danger" onclick="lineaDel('${id}')">X</button>
    </div>
  </div>`;
}
function recalcFactura(){
  const rows=[...$$('#lineas [data-k="cant"]')].map(el=>{
    const id=el.dataset.id;
    const cant=+el.value||0;
    const precio=+byId(`lineas`).querySelector(`[data-id="${id}"][data-k="precio"]`).value||0;
    const tot=cant*precio;
    byId('lineas').querySelector(`[data-id="${id}"][data-k="total"]`).value=fmtMoney(tot);
    return tot;
  });
  const sub = rows.reduce((a,b)=>a+b,0);
  const ivu = sub*(+byId('f_ivu').value/100);
  const tot = sub+ivu;
  byId('f_sub').value=fmtMoney(sub);
  byId('f_tax').value=fmtMoney(ivu);
  byId('f_total').value=fmtMoney(tot);
  byId('ath_monto').value=fmtMoney(tot);
}
function lineaAdd(data={}){
  const id=uuid();
  byId('lineas').insertAdjacentHTML('beforeend', lineaTpl(id,data));
  ['cant','precio'].forEach(k=>{
    byId('lineas').querySelector(`[data-id="${id}"][data-k="${k}"]`).addEventListener('input', recalcFactura);
  });
  recalcFactura();
}
function lineaDel(id){
  const node=[...byId('lineas').children].find(div=>div.querySelector(`[data-id="${id}"]`));
  if(node) node.remove(); recalcFactura();
}
function facturaNueva(){
  byId('f_num').value = nextFacturaNumber();
  byId('f_cli').value=''; byId('f_tel').value='';
  byId('f_emp').value = (load(K.EMP,[])[0]||{}).id||'';
  byId('f_fecha').value = todayISO();
  byId('f_notas').value='';
  byId('f_pago').value='ATH M√≥vil';
  byId('lineas').innerHTML='';
  recalcFactura();
}
function facturaGuardar(){
  const num=byId('f_num').value || nextFacturaNumber();
  const cli=byId('f_cli').value.trim();
  const tel=byId('f_tel').value.trim();
  const emp=byId('f_emp').value;
  const fecha=byId('f_fecha').value;
  const pago=byId('f_pago').value;
  const ivu=+byId('f_ivu').value;
  const notas=byId('f_notas').value.trim();
  const items=[...$$('#lineas [data-k="desc"]')].map(el=>{
    const id=el.dataset.id;
    const cant=+byId('lineas').querySelector(`[data-id="${id}"][data-k="cant"]`).value||0;
    const precio=+byId('lineas').querySelector(`[data-id="${id}"][data-k="precio"]`).value||0;
    return {desc:el.value, cant, precio};
  });
  if(!cli || !fecha || items.length===0) return alert('Cliente, fecha y al menos una l√≠nea.');
  const sub=items.reduce((a,i)=>a+i.cant*i.precio,0), tax=sub*(ivu/100), tot=sub+tax;
  let facts=load(K.FACTS,[]);
  const exists=facts.find(x=>x.num==num);
  const data={id:exists?.id||uuid(), num, cli, tel, emp, fecha, pago, ivu, notas, items, sub, tax, tot};
  if(exists){ facts = facts.map(x=> x.num==num? data : x); } else { facts.push(data); }
  save(K.FACTS,facts);
  renderFacturas();
  alert('Factura guardada.');
}
function renderFacturas(){
  const tb=byId('tblFacturas').querySelector('tbody');
  let facts=load(K.FACTS,[]);
  // filtros
  const d=byId('h_desde').value, h=byId('h_hasta').value, e=byId('h_emp').value;
  if(d) facts=facts.filter(f=>f.fecha>=d);
  if(h) facts=facts.filter(f=>f.fecha<=h);
  if(e) facts=facts.filter(f=>f.emp===e);
  facts.sort((a,b)=> (b.fecha+a.num).localeCompare(a.fecha+b.num));
  const emps=load(K.EMP,[]); const empName=id=>(emps.find(x=>x.id===id)||{}).nombre||'';
  tb.innerHTML=facts.map(f=>`
    <tr class="tr">
      <td>${f.num}</td><td>${f.fecha}</td><td>${f.cli}</td><td>${empName(f.emp)}</td>
      <td>${f.pago}</td><td>${fmtMoney(f.tot)}</td>
      <td class="no-print">
        <button class="btn-ghost" onclick="factImprimir(${f.num})">PDF</button>
        <button class="btn-ghost" onclick="factCSV(${f.num})">CSV</button>
        <button class="btn-ghost" onclick="factWA(${f.num})">WA</button>
        <button class="btn-danger" onclick="factDel(${f.num})">X</button>
      </td>
    </tr>`).join('');
}
function factData(num){
  return load(K.FACTS,[]).find(f=>f.num==num);
}
function factDel(num){
  save(K.FACTS, load(K.FACTS,[]).filter(f=>f.num!=num));
  renderFacturas();
}
function factWA(num){
  const cfg=load(K.CFG,{});
  const f=factData(num); if(!f) return;
  const msg = encodeURIComponent(
    `${cfg.waFacto||'Gracias por su compra.'}\n`+
    `Factura #${f.num}\nFecha: ${f.fecha}\nTotal: ${fmtMoney(f.tot)}\n`+
    `${cfg.maps? 'Ubicaci√≥n: '+cfg.maps+'\n':''}`+
    `Detalle:\n`+f.items.map(i=>`‚Ä¢ ${i.desc} x${i.cant} = ${fmtMoney(i.cant*i.precio)}`).join('\n')
  );
  const phone = (f.tel||cfg.waPhone||'').replace(/\D/g,'');
  window.open(`https://wa.me/${phone}?text=${msg}`,'_blank');
}
function factCSV(num){
  const f=factData(num); if(!f) return;
  let csv='Descripcion,Cantidad,Precio,Total\n';
  f.items.forEach(i=> csv+=`${i.desc},${i.cant},${i.precio},${(i.cant*i.precio).toFixed(2)}\n`);
  csv+=`\nSubtotal,, ,${f.sub.toFixed(2)}\nIVU (${f.ivu}%),, ,${f.tax.toFixed(2)}\nTotal,, ,${f.tot.toFixed(2)}\n`;
  download(`Factura_${f.num}.csv`, csv, 'text/csv');
}
function factImprimir(num){
  // Crea ventana con contenido imprimible (para PDF)
  const f=factData(num); if(!f) return;
  const emps=load(K.EMP,[]); const empName=id=>(emps.find(x=>x.id===id)||{}).nombre||'';
  const cfg=load(K.CFG,{});
  const html=`
  <html><head><meta charset="utf-8"><title>Factura ${f.num}</title>
  <style>
    body{font-family:${getComputedStyle(document.documentElement).getPropertyValue('--font')}; padding:20px}
    h1,h2,h3{margin:0}
    table{width:100%; border-collapse:collapse; margin-top:10px}
    th,td{border:1px solid #ddd; padding:8px}
    .right{text-align:right}
  </style></head><body>
  <h2>${cfg.name||'Salon Pro'}</h2>
  <div>${cfg.sub||''}</div>
  <hr>
  <h3>Factura #${f.num}</h3>
  <div>Fecha: ${f.fecha}</div>
  <div>Cliente: ${f.cli}</div>
  <div>Tel: ${f.tel||''}</div>
  <div>Empleado: ${empName(f.emp)}</div>
  <table>
    <thead><tr><th>Descripci√≥n</th><th>Cant</th><th>Precio</th><th>Total</th></tr></thead>
    <tbody>
      ${f.items.map(i=>`<tr><td>${i.desc}</td><td class="right">${i.cant}</td><td class="right">${i.precio.toFixed(2)}</td><td class="right">${(i.cant*i.precio).toFixed(2)}</td></tr>`).join('')}
    </tbody>
  </table>
  <h3 class="right">Subtotal: ${f.sub.toFixed(2)}</h3>
  <h3 class="right">IVU (${f.ivu}%): ${f.tax.toFixed(2)}</h3>
  <h2 class="right">Total: ${f.tot.toFixed(2)}</h2>
  <p>${cfg.waFacto||''}</p>
  </body></html>`;
  const w=window.open('','_blank'); w.document.write(html); w.document.close(); w.focus(); w.print();
}

/* ============================================================
   EXPORTACIONES (rango y CSV/Print)
   ============================================================ */
function rango(periodo, base){
  const d=new Date(base||todayISO());
  let ini=new Date(d), fin=new Date(d);
  if(periodo==='dia'){ /* mismo d√≠a */ }
  if(periodo==='semana'){
    const day=d.getDay(); // 0 dom
    ini.setDate(d.getDate()-(day||7)+1); fin=new Date(ini); fin.setDate(ini.getDate()+6);
  }
  if(periodo==='mes'){
    ini=new Date(d.getFullYear(), d.getMonth(), 1);
    fin=new Date(d.getFullYear(), d.getMonth()+1, 0);
  }
  if(periodo==='anio'){
    ini=new Date(d.getFullYear(),0,1); fin=new Date(d.getFullYear(),11,31);
  }
  const toISO=x=>x.toISOString().slice(0,10);
  return {desde:toISO(ini), hasta:toISO(fin)};
}
function exportPreview(){
  const tipo=byId('ex_tipo').value;
  const emp=byId('ex_emp').value;
  const per=byId('ex_periodo').value;
  let {desde,hasta} = per==='rango' ? {desde:byId('ex_desde').value, hasta:byId('ex_hasta').value}
                                    : rango(per, byId('ex_fecha').value||todayISO());
  if(!desde||!hasta) { const r=rango('dia', todayISO()); desde=r.desde; hasta=r.hasta; }
  let head=[], rows=[];
  if(tipo==='facturas'){
    let facts=load(K.FACTS,[]).filter(f=>f.fecha>=desde && f.fecha<=hasta);
    if(emp) facts=facts.filter(f=>f.emp===emp);
    head=['#','Fecha','Cliente','Empleado','M√©todo','Subtotal','IVU','Total'];
    rows=facts.map(f=>[f.num,f.fecha,f.cli,f.emp,f.pago,f.sub.toFixed(2),f.tax.toFixed(2),f.tot.toFixed(2)]);
  }else{
    let citas=load(K.CITAS,[]).filter(c=>c.fecha>=desde && c.fecha<=hasta);
    if(emp) citas=citas.filter(c=>c.emp===emp);
    head=['Fecha','Hora','Cliente','Empleado','Servicio','Tel','Estado'];
    rows=citas.map(c=>[c.fecha,c.hora,c.nombre,c.emp,c.srv||'',c.tel,c.estado]);
  }
  const emps=load(K.EMP,[]); const empName=id=>(emps.find(x=>x.id===id)||{}).nombre||'';
  // pintar head
  byId('exHead').innerHTML = head.map(h=>`<th>${h}</th>`).join('');
  byId('exBody').innerHTML = rows.map(r=>`
    <tr class="tr">${r.map((c,i)=>`<td>${i===3? empName(c): c}</td>`).join('')}</tr>
  `).join('');
  return {head, rows, desde, hasta};
}
function exportCSV(){
  const tipo=byId('ex_tipo').value;
  const emp=byId('ex_emp').value;
  const {head, rows, desde, hasta}=exportPreview();
  let csv=head.join(',')+'\n';
  rows.forEach(r=> csv+=r.join(',')+'\n');
  const suf = tipo==='facturas'?'FACTURAS':'CITAS';
  download(`${suf}_${desde}_a_${hasta}.csv`, csv, 'text/csv');
}
function exportPrint(){
  const tipo=byId('ex_tipo').value;
  const {head, rows, desde, hasta}=exportPreview();
  const html=`
  <html><head><meta charset="utf-8"><title>Exportaci√≥n</title>
  <style>
    body{font-family:${getComputedStyle(document.documentElement).getPropertyValue('--font')}; padding:20px}
    table{width:100%; border-collapse:collapse; margin-top:10px}
    th,td{border:1px solid #ddd; padding:6px}
    h2,h3{margin:0}
  </style>
  </head><body>
    <h2>Exportaci√≥n ${tipo.toUpperCase()}</h2>
    <h3>${desde} a ${hasta}</h3>
    <table><thead><tr>${head.map(h=>`<th>${h}</th>`).join('')}</tr></thead>
    <tbody>${rows.map(r=>`<tr>${r.map(c=>`<td>${c}</td>`).join('')}</tr>`).join('')}</tbody></table>
  </body></html>`;
  const w=window.open('','_blank'); w.document.write(html); w.document.close(); w.focus(); w.print();
}
/* ============================================================
   ANALYTICS (KPIs + chart 30 d√≠as)
   ============================================================ */
function analyticsKPIs(){
  const facts=load(K.FACTS,[]);
  const citas=load(K.CITAS,[]);
  const hoy=todayISO(); const ym=hoy.slice(0,7);
  const suma = arr => arr.reduce((a,b)=>a+b,0);
  const ingresosHoy = suma(facts.filter(f=>f.fecha===hoy).map(f=>f.tot));
  const ingresosMes = suma(facts.filter(f=>f.fecha.startsWith(ym)).map(f=>f.tot));
  const citasHoy = citas.filter(c=>c.fecha===hoy).length;
  const noshowMes = citas.filter(c=>c.fecha.startsWith(ym) && c.estado==='no-show').length;
  byId('kpi_ingresos_hoy').textContent = fmtMoney(ingresosHoy);
  byId('kpi_ingresos_mes').textContent = fmtMoney(ingresosMes);
  byId('kpi_citas_hoy').textContent = citasHoy;
  byId('kpi_noshow_mes').textContent = noshowMes;
}
function analyticsChart30(){
  const facts=load(K.FACTS,[]);
  const days=[];
  for(let i=29;i>=0;i--){
    const d=new Date(); d.setDate(d.getDate()-i);
    const iso=d.toISOString().slice(0,10);
    const total=facts.filter(f=>f.fecha===iso).reduce((a,b)=>a+b.tot,0);
    days.push({d,iso,total});
  }
  const cvs=byId('chart30'), ctx=cvs.getContext('2d');
  const W=cvs.width = cvs.clientWidth || 800, H=cvs.height;
  ctx.clearRect(0,0,W,H);
  const pad=30; const max=Math.max(1,...days.map(x=>x.total));
  ctx.strokeStyle='#cdd4ff'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(pad,10); ctx.lineTo(pad,H-pad); ctx.lineTo(W-10,H-pad); ctx.stroke();
  ctx.fillStyle='#9aa3c7'; ctx.font='12px sans-serif';
  for(let i=0;i<=4;i++){
    const val=max*i/4; const y=H-pad-(H-2*pad)*(val/max);
    ctx.fillText(fmtMoney(val).replace('$',''), 4, y+4);
    ctx.strokeStyle='rgba(205,212,255,.15)';
    ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(W-10,y); ctx.stroke();
  }
  const dx=(W-2*pad)/(days.length-1);
  ctx.beginPath();
  days.forEach((p,idx)=>{
    const x=pad+dx*idx;
    const y=H-pad-(H-2*pad)*(p.total/max);
    if(idx===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.strokeStyle='#93c5fd'; ctx.lineWidth=2; ctx.stroke();
}

/* ============================================================
   LOGIN (parche fiable) + NAV POR ROL
   ============================================================ */
function loginEnsureUsers(){
  let users = load(K.USERS, null);
  if(!Array.isArray(users) || users.length===0){
    users = [
      {user:'admin',   pass:'admin123', role:'admin'},
      {user:'usuario', pass:'user123',  role:'usuario'}
    ];
    save(K.USERS, users);
  }
}
function login(user, pass){
  loginEnsureUsers();
  const users=load(K.USERS,[]);
  const u=users.find(x=>x.user===user && x.pass===pass);
  if(!u) return false;
  save(K.SESSION,{user:u.user, role:u.role, ts:Date.now()});
  const av=byId('whoami'); if(av) av.title=`${u.user} (${u.role})`;
  return true;
}
function logout(){
  localStorage.removeItem(K.SESSION);
  show('screen-login');
}
// show con control por rol (usuario: solo agenda y facturaci√≥n)
function show(id){
  $$('.screen').forEach(s=>s.classList.remove('active'));
  byId(id).classList.add('active');
  const ses = load(K.SESSION);
  const adminOnly = ['screen-export','screen-analytics','screen-empleados','screen-config'];
  adminOnly.forEach(h=>{
    const el=byId(h); if(!el) return;
    if(ses?.role==='usuario') el.classList.add('hidden'); else el.classList.remove('hidden');
  });
}

/* ============================================================
   GOOGLE FORM PATCH (usa tus entry.xxxxx reales)
   ============================================================ */
// Usa tu formulario real (formResponse) + mapping desde tu prefill
function ensureDefaults_patchFormIDs(){
  const cfg = load(K.CFG, {}) || {};
  cfg.formUrl = cfg.formUrl || "https://docs.google.com/forms/d/e/1FAIpQLSf1UXh09WVyDvNF0tvzPEUQGsArmm81Ice53xoWgzpY-8Ae8g/formResponse";
  cfg.formMap = cfg.formMap || {
    nombre:   "entry.126099183",
    tel:      "entry.885012759",
    fecha:    "entry.2059036119", // mm/dd/yy
    hora:     "entry.805023101",  // HH:MM (24h)
    servicio: "entry.1764664020",
    tecnica:  "entry.1003942216",
    correo:   "entry.1481210954"
  };
  save(K.CFG, cfg);
}
// yyyy-mm-dd -> mm/dd/yy (lo que pide tu Form)
function toMMDDYY(iso){
  if(!iso || !/^\d{4}-\d{2}-\d{2}$/.test(iso)) return iso;
  const [y,m,d] = iso.split('-');
  return `${m}/${d}/${y.slice(2)}`;
}
// Enviar cita al Form con tu mapping
async function citaGoogle(){
  const cfg=load(K.CFG,{});
  if(!cfg.formUrl){ alert('Configura la URL de formResponse.'); return; }
  const m=cfg.formMap||{};
  const nombre=byId('a_nombre').value.trim();
  const tel=byId('a_tel').value.trim();
  const emp=byId('a_emp').value;
  const srv=byId('a_srv').value.trim();
  const fechaISO=byId('a_fecha').value;
  const hora24=byId('a_hora').value;
  if(!nombre||!tel||!emp||!fechaISO||!hora24){ alert('Completa nombre, tel√©fono, empleado, fecha y hora.'); return; }
  const emps=load(K.EMP,[]); 
  const empName=(emps.find(e=>e.id===emp)||{}).nombre||'';
  const payload = new URLSearchParams({
    [m.nombre]:   nombre,
    [m.tel]:      tel,
    [m.fecha]:    toMMDDYY(fechaISO),
    [m.hora]:     hora24,
    [m.servicio]: srv,
    [m.tecnica]:  empName,
    [m.correo]:   "" // si no usas correo en pantalla, queda vac√≠o
  });
  try{
    await fetch(cfg.formUrl,{method:'POST', body:payload, mode:'no-cors'});
    alert('Cita enviada a Google Form.');
  }catch(e){ console.error(e); alert('Error enviando al Form.'); }
}

/* ============================================================
   EVENTOS UI (login handler actualizado)
   ============================================================ */
function bindUI(){
  // navegaci√≥n topbar
  byId('btnHome').onclick = ()=>show('screen-home');
  byId('btnConfig').onclick=()=>show('screen-config');
  byId('btnLogout').onclick=()=>{logout();};

  // botones de tarjetas
  $$('[data-goto]').forEach(b=> b.onclick=()=> show(b.dataset.goto));

  // LOGIN (handler nuevo + Enter)
  byId('doLogin').onclick = ()=>{
    const u = byId('loginUser').value.trim();
    const p = byId('loginPass').value.trim();
    const ok = login(u, p);
    if(!ok){
      alert('Credenciales inv√°lidas. Usa admin/admin123 o usuario/user123');
      return;
    }
    show('screen-home');
  };
  ['loginUser','loginPass'].forEach(id=>{
    const el=byId(id);
    el && el.addEventListener('keydown', e=>{
      if(e.key==='Enter') byId('doLogin').click();
    });
  });

  // EMPLEADOS
  byId('btnEmpGuardar')?.addEventListener('click', empSave);
  byId('btnEmpLimpiar')?.addEventListener('click', ()=>{ 
    byId('e_nombre').value=''; byId('e_tel').value=''; byId('e_activo').value='1'; 
    delete byId('btnEmpGuardar').dataset.id; 
  });

  // AGENDA
  byId('btnAgendaGuardar')?.addEventListener('click', citaGuardar);
  byId('btnAgendaNoShow')?.addEventListener('click', citaNoShow);
  byId('btnAgendaFiltrar')?.addEventListener('click', ()=>renderCitas(true));
  byId('btnAgendaWhatsApp')?.addEventListener('click', ()=>{
    const temp={id:'temp', nombre:byId('a_nombre').value, tel:byId('a_tel').value, emp:byId('a_emp').value, srv:byId('a_srv').value, fecha:byId('a_fecha').value, hora:byId('a_hora').value, notas:byId('a_notas').value};
    load(K.CITAS,[]).push(temp); save(K.CITAS,load(K.CITAS,[])); citaWhatsApp('temp');
    save(K.CITAS, load(K.CITAS,[]).filter(x=>x.id!=='temp'));
  });
  byId('btnAgendaGoogle')?.addEventListener('click', citaGoogle);
  byId('btnAgendaImprimir')?.addEventListener('click', ()=>window.print());

  // FACTURACI√ìN
  byId('btnAddLinea')?.addEventListener('click', ()=>lineaAdd());
  byId('btnLoadServicios')?.addEventListener('click', ()=>renderServicios());
  byId('f_ivu')?.addEventListener('input', recalcFactura);
  byId('btnFacturaGuardar')?.addEventListener('click', facturaGuardar);
  byId('btnFacturaExportCSV')?.addEventListener('click', ()=>{ const n=byId('f_num').value; if(!n) return alert('Guarda primero.'); factCSV(n); });
  byId('btnFacturaExportPDF')?.addEventListener('click', ()=>{ const n=byId('f_num').value; if(!n) return alert('Guarda primero.'); factImprimir(n); });
  byId('btnFacturaWhatsApp')?.addEventListener('click', ()=>{ const n=byId('f_num').value; if(!n) return alert('Guarda primero.'); factWA(n); });
  byId('btnHistFiltrar')?.addEventListener('click', renderFacturas);

  // EXPORTACIONES
  byId('ex_periodo')?.addEventListener('change', ()=>{
    const isR=byId('ex_periodo').value==='rango';
    byId('ex_rango_wrap').style.display=isR?'grid':'none';
  });
  byId('btnExportCSV')?.addEventListener('click', exportCSV);
  byId('btnExportPrint')?.addEventListener('click', exportPrint);

  // SERVICIOS
  byId('btnSvAgregar')?.addEventListener('click', ()=>{
    const id=byId('btnSvAgregar').dataset.id;
    if(id){
      const sv=load(K.SVC,[]).map(s=> s.id===id ? {...s, nombre:byId('sv_nombre').value.trim(), precio:+byId('sv_precio').value||0} : s);
      save(K.SVC,sv); delete byId('btnSvAgregar').dataset.id;
      byId('sv_nombre').value=''; byId('sv_precio').value='';
      renderServicios();
    }else{
      const nombre=byId('sv_nombre').value.trim();
      const precio=+byId('sv_precio').value||0;
      if(!nombre) return alert('Nombre requerido');
      const sv=load(K.SVC,[]); sv.push({id:uuid(), nombre, precio}); save(K.SVC,sv);
      byId('sv_nombre').value=''; byId('sv_precio').value='';
      renderServicios();
    }
  });

  // CONFIG (branding + integraciones)
  byId('cfg_logo')?.addEventListener('change', onLogoChange);
  byId('cfg_bg')?.addEventListener('change', onBgChange);
  byId('cfg_name')?.addEventListener('input',  e=>cfgSave({name:e.target.value}));
  byId('cfg_sub')?.addEventListener('input',   e=>cfgSave({sub:e.target.value}));
  byId('cfg_bg_op')?.addEventListener('input', e=>cfgSave({bgOpacity:+e.target.value}));
  byId('cfg_primary')?.addEventListener('input', e=>cfgSave({primary:e.target.value}));
  byId('cfg_accent')?.addEventListener('input',  e=>cfgSave({accent:e.target.value}));
  byId('cfg_form_url')?.addEventListener('input',e=>cfgSave({formUrl:e.target.value}));
  byId('cfg_script_url')?.addEventListener('input',e=>cfgSave({scriptUrl:e.target.value}));
  byId('cfg_wa_phone')?.addEventListener('input',e=>cfgSave({waPhone:e.target.value}));
  byId('cfg_wa_fact')?.addEventListener('input', e=>cfgSave({waFacto:e.target.value}));
  byId('cfg_maps')?.addEventListener('input',    e=>cfgSave({maps:e.target.value}));
  byId('btnExportConfig')?.addEventListener('click', exportConfig);
  byId('cfgImport')?.addEventListener('change', e=>e.target.files[0] && importConfig(e.target.files[0]));
}

/* ============================================================
   INICIO (boot final)
   ============================================================ */
function boot(){
  ensureDefaults();               // datos base (usuarios, empleados, cfg, etc.)
  ensureDefaults_patchFormIDs();  // mapping Google Form + formResponse
  applyBrand();
  renderEmpleadosTabla();
  renderEmpleadosSelects();
  renderServicios();
  byId('a_fecha').value = todayISO();
  byId('f_fecha').value = todayISO();
  renderCitas();
  renderFacturas();
  facturaNueva();
  const ses=load(K.SESSION,null);
  if(ses){ byId('whoami').title=`${ses.user} (${ses.role})`; show('screen-home'); }
  else show('screen-login');
  analyticsKPIs(); analyticsChart30();
  bindUI();
}
// Importante: llama SIEMPRE a la versi√≥n final de boot (aunque sea reasignada)
window.addEventListener('DOMContentLoaded', ()=> boot());
/* ======== RESCUE PATCH: arranque seguro + diagn√≥stico ======== */
(function(){
  // 1) HUD de diagn√≥stico
  const hud = document.createElement('div');
  hud.id = '__app_hud__';
  hud.style.cssText = 'position:fixed;right:10px;bottom:10px;z-index:99999;padding:8px 10px;border-radius:8px;font:12px/1.2 ui-sans-serif,system-ui;background:#111827;color:#fff;border:1px solid #334155;box-shadow:0 8px 24px rgba(0,0,0,.35)';
  hud.textContent = 'Iniciando...';
  document.body.appendChild(hud);
  function ok(msg){ hud.style.background='#065f46'; hud.style.borderColor='#10b981'; hud.textContent='‚úÖ '+msg; }
  function bad(msg){ hud.style.background='#7f1d1d'; hud.style.borderColor='#ef4444'; hud.textContent='‚ùå '+msg; }

  // 2) Garantizar helpers b√°sicos
  window.byId = window.byId || (id=>document.getElementById(id));
  window.$ = window.$ || (s=>document.querySelector(s));
  window.$$ = window.$$ || (s=>document.querySelectorAll(s));

  // 3) Garantizar storage helpers + claves
  try{
    window.load = window.load || ((k,d=null)=>JSON.parse(localStorage.getItem(k)||JSON.stringify(d)));
    window.save = window.save || ((k,v)=>localStorage.setItem(k,JSON.stringify(v)));
  }catch(e){ /* safari private mode, etc. */ }

  window.K = window.K || {
    USERS:'sp_users', SESSION:'sp_session', EMP:'sp_empleados',
    CITAS:'sp_citas', FACTS:'sp_facturas', CFG:'sp_config',
    SVC:'sp_servicios', COUNTER_F:'sp_fact_counter'
  };

  // 4) Stubs (no-op) si faltan ‚Äî evitan que crashee boot()
  const stubs = [
    'ensureDefaults','applyBrand','renderEmpleadosTabla','renderEmpleadosSelects',
    'renderServicios','renderCitas','renderFacturas','facturaNueva',
    'analyticsKPIs','analyticsChart30','bindUI','show'
  ];
  stubs.forEach(fn=>{
    if(typeof window[fn] !== 'function'){
      console.warn('[RESCUE] faltaba', fn, '‚Üí creando stub.');
      window[fn] = function(){ /* no-op */ };
    }
  });

  // 5) Asegurar login m√≠nimo para no romper show('screen-login')
  if(typeof window.logout !== 'function'){
    window.logout = function(){ try{ localStorage.removeItem(K.SESSION);}catch(e){}; window.show('screen-login'); };
  }
  if(typeof window.login !== 'function'){
    window.login = function(u,p){
      let users = load(K.USERS, null);
      if(!Array.isArray(users) || users.length===0){
        users = [{user:'admin',pass:'admin123',role:'admin'},{user:'usuario',pass:'user123',role:'usuario'}];
        save(K.USERS, users);
      }
      const uobj = users.find(x=>x.user===u && x.pass===p);
      if(!uobj) return false;
      save(K.SESSION,{user:uobj.user,role:uobj.role,ts:Date.now()});
      const av=byId('whoami'); if(av) av.title=`${uobj.user} (${uobj.role})`;
      return true;
    };
  }

  // 6) Envolver boot() con try/catch y reportar error si ocurre
  function runBootSafe(){
    try{
      if(typeof window.boot !== 'function'){
        // definir un boot m√≠nimo que muestre login
        window.boot = function(){
          const ses = load(K.SESSION,null);
          if(ses){ byId('whoami') && (byId('whoami').title=`${ses.user} (${ses.role})`); window.show && window.show('screen-home'); }
          else window.show && window.show('screen-login');
        };
        console.warn('[RESCUE] boot no exist√≠a. Se cre√≥ uno b√°sico.');
      }
      window.boot(); // ejecutar versi√≥n actual (o la b√°sica)
      ok('App iniciada');
    }catch(err){
      console.error('[RESCUE] error en boot:', err);
      bad('Error: '+ (err && err.message ? err.message : err));
      // mostrar un alert amigable y c√≥mo limpiar
      setTimeout(()=>alert('Hubo un error iniciando la app.\n\nDetalle consola: '+err+'\n\nSugerencia r√°pida: abre la consola y pega:\nlocalStorage.clear();\nRecarga la p√°gina.'), 150);
    }
  }

  // 7) Usar DOMContentLoaded ‚Üí boot final
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', runBootSafe);
  }else{
    runBootSafe();
  }
})();
</script>
</body>
</html>
